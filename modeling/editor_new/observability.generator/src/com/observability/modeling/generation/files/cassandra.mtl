[comment encoding = UTF-8 /]
[**
 * The documentation of the module cassandra.
 */]
[module cassandra('http://www.observability.com/emf')]


[**
 * The documentation of the template generateCassandra.
 * @param aNodeMachine
 */]
[template public generateCassandra(aCluster : DatabaseCluster, frequency : Integer)]

[for (machine : NodeMachine | aCluster.machines)]

[file ( machine.IP +  '_' + machine.Port + '_collectd.conf' , false, 'UTF-8')]
Interval [frequency/]
Hostname [machine.IP/]

[for (metric : BaseMetric | aCluster.collectedBaseMetric)]
[if metric.type == 'system']
LoadPlugin "[metric.name/]"
<Plugin "[metric.name/]">
[for (kv : KeyValue | metric.keyValues)/]
keyValue.name keyValue.value
[/for]

#Loop at elements inside the machine. Find the element with the unique id
and display its key-values

</Plugin>
[/if]
[/for]


<Plugin "network">
  Server "[aCluster.eContainer(Model).serverIP/]"
</Plugin>

[for (noti : Notification | aCluster.associatedNotifications)]
LoadPlugin "threshold"
<Plugin "threshold">
  <Host "[aCluster.eContainer(Model).serverIP/]">
    <Type "[noti.type/]">
	[if noti.warningMin <> 0.0]
     WarningMin    [noti.warningMin/]
	[/if]
	[if noti.warningMax <> 0.0]
     WarningMax    [noti.warningMax/]
	[/if]
	[if noti.failureMin <> 0.0]
     FailureMin    [noti.failureMin/]
	[/if]
	[if noti.failureMax <> 0.0]
     FailureMax    [noti.failureMax/]
	[/if]
     Invert [noti.invert/]
	[if noti.dataSource.strcmp('') <> 0]
	 DataSource [noti.dataSource/]
	[/if]
	Persist [noti.persist/]
	Percentage [noti.percentage/]
	[if noti.hits <> 0]
	 Hits [noti.hits/]
	[/if]	
	[if noti.hysteresis <> 0]
	 Hysteresis [noti.hysteresis/]
	[/if]
	 PersistOK [noti.persistOk/]
	 Interesting [noti.interesting/]
     Instance "[noti.instance/]"
    </Type>
   </Host>
 </Plugin>
[/for]

<Plugin "java">

    JVMARG "-Djava.class.path=/opt/collectd/java-dep/generic-jmx.jar:/opt/collectd/java-dep/collectd-api.jar"
    LoadPlugin "org.collectd.java.GenericJMX"
<Plugin "GenericJMX">
	
	[for dbMetric : BaseMetric | aCluster.collectedBaseMetric]
	[if dbMetric.type = 'database']
    <MBean dbMetric.name>
        [for keyValue : KeyValue | dbMetric.keyValues]
        [keyValue.name/] "[keyValue.value/]"
        [/for]
        
        [for element : Element | dbMetric.elements]
        <Value>
        [for keyValue : KeyValue | element.keyValues]
        [keyValue.name/] "[keyValue.value/]"
        [/for]
        [/for]
    </MBean>        
        
    
  [for (element : Element | machine.elements)]
	[if element.name.strcmp('Connection') = 0]
    <Connection>
	  [for (keyValue : KeyValue | element.keyValues)]
	  [keyValue.key/] "[keyValue.value/]"
	  [/for]
<<<<<<< Updated upstream
	  [for (m : Metric | aCluster.collectedMetrics) ]
		[if m.oclIsKindOf(BaseMetric)]
	  		Collect "[m.name/]"		
		[/if]
=======
	  [for (m : BaseMetric | aCluster.collectedBaseMetric) ]
	  [if m.type = 'database']
	  Collect "[m.name/]"		
	  [/if]
>>>>>>> Stashed changes
	  [/for]	  	
    </Connection>
	[/if]
  [/for]
  </Plugin>
</Plugin>
[/file]

[/for]

[/template]
